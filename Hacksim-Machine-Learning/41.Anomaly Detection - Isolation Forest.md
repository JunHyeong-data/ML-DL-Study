# Isolation Tree & Isolation Forest 정리

## 1. 일반적인 결정트리와 Optimal Tree (OT)의 차이

### 1.1 일반적인 결정트리
- 데이터의 **부분집합(subset)** 에 대해
  - 최적의 분할 변수
  - 최적의 분할 기준(split point)
- 를 반복적으로 선택함
- 즉, **각 노드마다 해당 노드에 포함된 데이터만 사용**

### 1.2 Optimal Tree (OT)
- 모든 노드에서
  - **전체 데이터 전체를 기준**으로
  - 분할 변수와 분할 기준을 동시에 최적화
- 전역적으로 최적 구조를 찾음
- 문제점:
  - **NP-hard 문제**
  - 완전한 최적해는 현실적으로 계산 불가능
- 최근 연구:
  - Relaxation, 근사해법을 통해
  - 제한된 시간 안에 “거의 Optimal”한 트리 구성

👉 우리가 일반적으로 사용하는 결정트리는 **OT가 아님**

---

## 2. Isolation Tree의 핵심 아이디어
<img width="1425" height="1004" alt="image" src="https://github.com/user-attachments/assets/beb7c221-9d25-4e73-807a-5de7e5cedd87" />
<img width="1405" height="1000" alt="image" src="https://github.com/user-attachments/assets/f67e2771-17c0-4fd7-a2f0-e599fd65be0d" />
<img width="1414" height="1001" alt="image" src="https://github.com/user-attachments/assets/f026c0d9-c016-4b03-a38e-013f70251c8f" />

### 2.1 기존 결정트리와의 가장 큰 차이
| 항목 | 결정트리 | Isolation Tree |
|----|----|----|
| 목적 | 예측 (분류/회귀) | 이상치 탐지 |
| 타겟 변수 y | 있음 | **없음** |
| 분할 기준 | 엔트로피, Gini, MSE | **완전 랜덤** |

---

## 3. 이상치의 정의 (Isolation 관점)

- **이상치란?**
  - 다른 데이터로부터 **빨리 고립(isolated)** 되는 점
- 정상 데이터:
  - 군집 내부에 존재
  - 고립시키려면 **많은 분할 필요**
- 이상 데이터:
  - 혼자 떨어져 있음
  - **몇 번 분할만으로 고립 가능**

---

## 4. Path Length (패스 길이)
<img width="1420" height="1009" alt="image" src="https://github.com/user-attachments/assets/88d3f05e-ff63-4a5c-8514-577a8d6b7a40" />

### 4.1 정의
- 한 관측치가
  - **단 하나의 데이터만 포함된 리프 노드**
  - 에 도달할 때까지 필요한 분할 횟수

### 4.2 해석
- Path Length ↓ → 이상치 가능성 ↑
- Path Length ↑ → 정상 데이터 가능성 ↑

---

## 5. Isolation Tree 생성 방법
<img width="1407" height="1003" alt="image" src="https://github.com/user-attachments/assets/5e8b2344-357e-4f7d-8df7-184b67d56a1f" />

### 5.1 분할 방식
- 변수 선택: **랜덤**
- 분할 기준값: **랜덤**
- y 사용 ❌
- 비용 함수 ❌

### 5.2 트리 생성 규칙
- 리프 노드에 관측치가 **1개만 남을 때까지**
- 또는 최대 깊이 도달 시 종료

---

## 6. Isolation Forest

### 6.1 왜 Forest인가?
- 랜덤 분할은 불안정
- 그래서:
  - 여러 개의 Isolation Tree 생성
  - 평균적인 특성을 사용

### 6.2 데이터 샘플링
- 각 트리마다:
  - 전체 데이터가 아닌
  - **랜덤 서브샘플** 사용 (예: 256, 512, 700개)

---

## 7. 이상치 점수 (Anomaly Score)
<img width="1412" height="999" alt="image" src="https://github.com/user-attachments/assets/37d86380-2291-49bf-b6be-a201f04b50d9" />

### 7.1 평균 Path Length
- 하나의 관측치 x에 대해:
  - 여러 트리에서 얻은 path length 평균
  - 이를 **E[h(x)]** 로 표현

### 7.2 정규화 상수 c(n)
- 모든 데이터의 평균 path length
- 이론적으로 계산 가능 (오일러 상수 γ 포함)

### 7.3 최종 이상치 점수
```math
s(x) = 2^{-\frac{E[h(x)]}{c(n)}}
````

---

## 8. 점수 해석

| s(x) 값 | 의미     |
| ------ | ------ |
| ≈ 1    | 강한 이상치 |
| ≈ 0.5  | 애매     |
| ≈ 0    | 정상 데이터 |

* 0~1 사이 값 → **해석 쉬움**
* LOF 대비 장점:

  * 명확한 스케일
  * 파라미터 민감도 낮음

---

## 9. 시각화 해석 (주의)
<img width="1412" height="998" alt="image" src="https://github.com/user-attachments/assets/1cded62d-2104-459b-b785-21006cd38d26" />

* 색상으로 표현한 결과는 **참고용**
* 진짜 판단은 **점수 값 기준**
* 시각화는:

  * 모델이 잡아내는 패턴 이해용

---

## 10. 확장 연구 (간단 언급)

* Extended Isolation Forest 등 존재
* 특이한 데이터 분포(별 모양 등)에 대응
* 일반적인 경우:

  * **기본 Isolation Forest로 충분**

---

## 11. 요약 한 줄

> **Isolation Forest는
> "라벨 없이, 랜덤 분할로, 얼마나 빨리 고립되는지를 평균적으로 측정하는 이상치 탐지 모델"이다.**
